<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Fantasy Player Tiering Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --border-color: rgba(148, 163, 184, 0.2);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --forward-color: #3b82f6;
            --defense-color: #10b981;
            --goalie-color: #8b5cf6;
            --gradient-main: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; }
        
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--gradient-main);
            color: var(--text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: floatingBg 20s ease-in-out infinite;
        }

        @keyframes floatingBg {
            0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0.7; }
            50% { transform: translate(15px, -15px) rotate(2deg); opacity: 1; }
        }

        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            position: relative;
            z-index: 100;
        }

        header::before {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
        }

        h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6, #10b981, #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }

        .header-buttons { display: flex; gap: 12px; }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before { left: 100%; }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), #2563eb);
            color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .container { display: flex; height: calc(100vh - 70px); padding: 1rem; gap: 1rem; }

        .sidebar, .pool-wrapper {
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex; flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .sidebar::before, .pool-wrapper::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-purple));
        }

        .sidebar { flex: 0 0 350px; overflow-y: auto; }
        .pool-wrapper { flex: 0 0 400px; }
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .column-header h2 { margin: 0; font-size: 1.25rem; font-weight: 700; }

        .toggle-btn {
            background: var(--bg-glass); border: 1px solid var(--border-color);
            color: var(--text-secondary); width: 32px; height: 32px;
            border-radius: 50%; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all 0.3s ease; backdrop-filter: blur(10px);
            position: absolute; top: -5px; right: -5px; z-index: 10;
        }
        .toggle-btn:hover {
            background: var(--accent-blue); color: white; transform: scale(1.1);
        }

        .sidebar.collapsed, .pool-wrapper.collapsed {
            flex-basis: 50px; padding-left: 0; padding-right: 0; overflow: hidden;
        }
        .sidebar.collapsed > *, .pool-wrapper.collapsed > * {
            opacity: 0; visibility: hidden;
        }
        .sidebar.collapsed .column-header, .pool-wrapper.collapsed .column-header {
            opacity: 1; visibility: visible;
        }
        .sidebar.collapsed .column-header h2, .pool-wrapper.collapsed .column-header h2 {
            display: none;
        }
        .sidebar.collapsed .toggle-btn, .pool-wrapper.collapsed .toggle-btn {
            transform: rotate(180deg);
        }

        #tiers-container {
            flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1rem; align-content: start; overflow-y: auto; padding-right: 10px;
        }

        .tier {
            background: var(--bg-glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border-color); border-radius: 12px;
            padding: 1rem; position: relative; transition: all 0.3s ease;
        }
        .tier:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        .tier h3 {
            margin: 0 0 1rem 0; display: flex; justify-content: space-between;
            align-items: center; font-weight: 700; color: var(--text-primary);
        }

        .tier-badge {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white; padding: 0.25rem 0.75rem; border-radius: 20px;
            font-size: 0.875rem; font-weight: 600;
        }
        .slot-count { color: var(--text-muted); font-weight: 500; }

        .tier-slots {
            min-height: 60px; border-radius: 8px; border: 2px dashed var(--border-color);
            padding: 0.5rem; transition: all 0.3s ease;
        }
        .tier-slots:empty { background: rgba(255, 255, 255, 0.02); }

        .tier-slots.sortable-chosen {
            border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1);
        }

        .player-card {
            background: var(--bg-card); backdrop-filter: blur(10px);
            border: 2px solid var(--border-color); border-radius: 12px;
            padding: 1rem; margin: 0.5rem 0;
            position: relative; cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .player-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: var(--forward-color); transition: all 0.3s ease;
        }
        .player-card.border-defenseman::before { background: var(--defense-color); }
        .player-card.border-goalie::before { background: var(--goalie-color); }

        .player-card:hover {
            transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--forward-color);
        }
        .player-card.border-defenseman:hover { border-color: var(--defense-color); }
        .player-card.border-goalie:hover { border-color: var(--goalie-color); }
        .player-card:active { cursor: grabbing; transform: rotate(5deg) scale(1.05); }

        .player-card.stricken {
            opacity: 0.4; filter: grayscale(100%); transform: none !important;
        }
        .player-card.stricken .player-name { text-decoration: line-through; }
        .player-info { display: flex; align-items: center; margin-bottom: 0.75rem; }

        .team-logo {
            width: 32px; height: 32px; border-radius: 50%; margin-right: 0.75rem;
            object-fit: contain; border: 2px solid var(--border-color);
        }
        .player-details { flex: 1; }
        .player-name {
            font-size: 1rem; font-weight: 700;
            color: var(--text-primary); margin: 0 0 0.25rem 0;
        }
        .player-meta {
            color: var(--text-secondary); font-size: 0.875rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .position-badge {
            background: var(--forward-color); color: white; padding: 0.125rem 0.5rem;
            border-radius: 12px; font-size: 0.75rem; font-weight: 600;
        }
        .position-badge.defense { background: var(--defense-color); }
        .position-badge.goalie { background: var(--goalie-color); }
        .star-icon {
            position: absolute; top: 0.75rem; right: 0.75rem;
            font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; z-index: 10;
            color: var(--text-muted);
        }
        .star-icon:hover { transform: scale(1.2); }
        .star-icon.favorited {
            color: var(--accent-yellow); text-shadow: 0 0 10px var(--accent-yellow);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .stat-pill {
            padding: 0.5rem; border-radius: 8px; text-align: center;
            font-size: 0.75rem; font-weight: 600; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .stat-pill::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .stat-pill:hover::before { left: 100%; }
        .pill-elite {
            background: linear-gradient(135deg, #10b981, #059669); color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .pill-good {
            background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .pill-average {
            background: var(--bg-glass); border: 1px solid var(--border-color); color: var(--text-secondary);
        }
        .pill-low {
            background: transparent; border: 1px solid rgba(239, 68, 68, 0.5); color: var(--text-muted);
        }

        .upload-section, .controls-section, .legend {
            background: var(--bg-glass); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1rem; margin-bottom: 1rem;
        }
        .upload-section h4, .controls-section h4, .legend h4 {
            margin: 0 0 0.75rem 0; color: var(--text-primary); font-weight: 600;
        }
        .file-input-wrapper {
            position: relative; overflow: hidden; display: inline-block; width: 100%;
        }
        .file-input { position: absolute; left: -9999px; opacity: 0; }
        .file-input-label {
            display: block; padding: 0.75rem 1rem; background: var(--bg-secondary);
            border: 2px dashed var(--border-color); border-radius: 8px;
            text-align: center; cursor: pointer; transition: all 0.3s ease; color: var(--text-secondary);
        }
        .file-input-label:hover {
            border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
        }
        .search-wrapper { position: relative; margin-bottom: 1rem; }
        #search-input {
            width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; background: var(--bg-secondary);
            border: 2px solid var(--border-color); border-radius: 10px; color: var(--text-primary);
            font-size: 1rem; transition: all 0.3s ease;
        }
        #search-input:focus {
            outline: none; border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .search-icon {
            position: absolute; left: 1rem; top: 50%;
            transform: translateY(-50%); color: var(--text-muted);
        }
        #player-pool {
            background: var(--bg-secondary); border-radius: 12px;
            padding: 1rem; flex: 1; overflow-y: auto;
        }
        .pool-content { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .sidebar-content { display: flex; flex-direction: column; }
        
        .filter-group, .sort-group {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
        }
        .checkbox-group { display: flex; gap: 0.5rem; }
        .checkbox-wrapper { display: flex; align-items: center; }
        .checkbox-wrapper input { display: none; }
        .checkbox-wrapper label {
            padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            font-size: 0.875rem; font-weight: 600;
        }
        .checkbox-wrapper input:checked + label {
            background: var(--accent-blue); border-color: var(--accent-blue); color: white;
        }
        select {
            padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-primary);
        }
        .criteria-grid {
            display: grid; grid-template-columns: auto 1fr 1fr 1fr;
            gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;
        }
        .criteria-header {
            font-size: 0.75rem; color: var(--text-muted); text-align: center; font-weight: 600;
        }
        .criteria-label { font-weight: 600; color: var(--text-primary); }
        .criteria-input {
            padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-primary); text-align: center;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #2563eb, #7c3aed); }

        @media (max-width: 1200px) {
            #tiers-container { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
            .sidebar, .pool-wrapper { flex-basis: 280px; }
        }

        .sortable-ghost { opacity: 0.5; background: rgba(59, 130, 246, 0.2) !important; transform: rotate(5deg); }
        .sortable-drag { box-shadow: var(--shadow-xl) !important; z-index: 1000; }
    </style>
</head>
<body>
    <header>
        <h1>🏒 NHL Fantasy Player Tiering Tool</h1>
        <div class="header-buttons">
            <button id="save-btn" class="btn btn-success">💾 Save Progress</button>
            <button id="export-btn" class="btn btn-primary">📊 Export Tiers</button>
        </div>
    </header>

    <main class="container">
        <aside class="sidebar">
            <div class="column-header">
                <h2>⚙️ Setup & Controls</h2>
                <button class="toggle-btn" id="toggle-sidebar-btn">←</button>
            </div>
            <div class="sidebar-content">
                <div class="upload-section">
                    <h4>📁 File Management</h4>
                    <div class="file-input-wrapper">
                        <input type="file" id="csv-file" class="file-input" accept=".csv">
                        <label for="csv-file" class="file-input-label">
                            📊 Upload Player CSV File
                        </label>
                    </div>
                    <div class="file-input-wrapper" style="margin-top: 0.5rem;">
                        <input type="file" id="json-file" class="file-input" accept=".json">
                        <label for="json-file" class="file-input-label">
                            📂 Load Saved Progress
                        </label>
                    </div>
                </div>

                <div class="legend">
                    <h4>📊 Stat Criteria</h4>
                    <div class="criteria-grid">
                        <div></div>
                        <div class="criteria-header">Elite ≥</div>
                        <div class="criteria-header">Good ≥</div>
                        <div class="criteria-header">Low <</div>
                        
                        <div class="criteria-label">PTS</div>
                        <input type="number" id="pts-elite" class="criteria-input">
                        <input type="number" id="pts-good" class="criteria-input">
                        <input type="number" id="pts-low" class="criteria-input">
                        
                        <div class="criteria-label">SOG</div>
                        <input type="number" id="sog-elite" class="criteria-input">
                        <input type="number" id="sog-good" class="criteria-input">
                        <input type="number" id="sog-low" class="criteria-input">
                        
                        <div class="criteria-label">HITS</div>
                        <input type="number" id="hits-elite" class="criteria-input">
                        <input type="number" id="hits-good" class="criteria-input">
                        <input type="number" id="hits-low" class="criteria-input">
                    </div>
                    <button id="update-criteria-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                        ✅ Apply Criteria
                    </button>
                </div>

                <div class="controls-section">
                    <h4>🔧 Sort & Filter</h4>
                    <div class="sort-group">
                        <label>Sort by:</label>
                        <select id="sort-select">
                            <option value="LWLRANK-asc">Default Rank</option>
                            <option value="P_PTS-desc">Points (High → Low)</option>
                            <option value="P_SOG-desc">Shots (High → Low)</option>
                            <option value="P_H-desc">Hits (High → Low)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Show positions:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="filter-f" value="forward" checked>
                                <label for="filter-f">F</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="filter-d" value="defenseman" checked>
                                <label for="filter-d">D</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="filter-g" value="goalie" checked>
                                <label for="filter-g">G</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="pool-wrapper">
            <div class="column-header">
                <h2>🏊 Player Pool</h2>
                <button class="toggle-btn" id="toggle-pool-btn">→</button>
            </div>
            <div class="pool-content">
                <div class="search-wrapper">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="search-input" placeholder="Search for a player...">
                </div>
                <div id="player-pool"></div>
            </div>
        </section>

        <section id="tiers-container"></section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const teamNameMap = {
                'ANA': 'Anaheim', 'UTA': 'Arizona', 'BOS': 'Boston', 'BUF': 'Buffalo',
                'CGY': 'Calgary', 'CAR': 'Carolina', 'CHI': 'Chicago', 'COL': 'Colorado',
                'CBJ': 'Columbus', 'DAL': 'Dallas', 'DET': 'Detroit', 'EDM': 'Edmonton',
                'FLA': 'Florida', 'LAK': 'Los Angeles', 'MIN': 'Minnesota', 'MTL': 'Montreal',
                'NSH': 'Nashville', 'NJD': 'New Jersey', 'NYI': 'NY Islanders', 'NYR': 'NY Rangers',
                'OTT': 'Ottawa', 'PHI': 'Philadelphia', 'PIT': 'Pittsburgh', 'SJS': 'San Jose',
                'SEA': 'Seattle', 'STL': 'St. Louis', 'TBL': 'Tampa Bay', 'TOR': 'Toronto',
                'UTA': 'Utah', 'VAN': 'Vancouver', 'VGK': 'Vegas', 'WSH': 'Washington', 'WPG': 'Winnipeg'
            };

            const elements = {
                mainContainer: document.querySelector('main.container'),
                sidebar: document.querySelector('.sidebar'),
                poolWrapper: document.querySelector('.pool-wrapper'),
                toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
                togglePoolBtn: document.getElementById('toggle-pool-btn'),
                fileInput: document.getElementById('csv-file'),
                jsonFileInput: document.getElementById('json-file'),
                searchInput: document.getElementById('search-input'),
                exportBtn: document.getElementById('export-btn'),
                saveBtn: document.getElementById('save-btn'),
                playerPool: document.getElementById('player-pool'),
                tiersContainer: document.getElementById('tiers-container'),
                updateCriteriaBtn: document.getElementById('update-criteria-btn'),
                sortSelect: document.getElementById('sort-select'),
                filterCheckboxes: document.querySelectorAll('.checkbox-wrapper input[type="checkbox"]')
            };

            let allPlayersData = [];
            let criteria = {
                pts: { elite: 100, good: 75, low: 40 },
                sog: { elite: 300, good: 225, low: 150 },
                hits: { elite: 200, good: 125, low: 50 },
            };

            initializeCriteriaForm();
            setupEventListeners();

            function setupEventListeners() {
                elements.toggleSidebarBtn.addEventListener('click', () => {
                    elements.sidebar.classList.toggle('collapsed');
                    updateCollapseUI();
                });

                elements.togglePoolBtn.addEventListener('click', () => {
                    elements.poolWrapper.classList.toggle('collapsed');
                    updateCollapseUI();
                });
                
                elements.mainContainer.addEventListener('click', handleCardClick);
                elements.fileInput.addEventListener('change', handleFileUpload);
                elements.jsonFileInput.addEventListener('change', handleLoad);
                elements.saveBtn.addEventListener('click', handleSave);
                elements.updateCriteriaBtn.addEventListener('click', handleCriteriaUpdate);
                elements.sortSelect.addEventListener('change', updateAndRenderPlayerPool);
                elements.filterCheckboxes.forEach(cb => cb.addEventListener('change', updateAndRenderPlayerPool));
                elements.searchInput.addEventListener('input', handleSearch);
                elements.exportBtn.addEventListener('click', handleExport);
            }

            function updateCollapseUI() {
                const sbCollapsed = elements.sidebar.classList.contains('collapsed');
                const pwCollapsed = elements.poolWrapper.classList.contains('collapsed');

                elements.toggleSidebarBtn.textContent = sbCollapsed ? '→' : '←';
                elements.toggleSidebarBtn.setAttribute('aria-label', sbCollapsed ? 'Expand Setup & Controls' : 'Collapse Setup & Controls');
                elements.toggleSidebarBtn.setAttribute('aria-expanded', (!sbCollapsed).toString());

                elements.togglePoolBtn.textContent = pwCollapsed ? '←' : '→';
                elements.togglePoolBtn.setAttribute('aria-label', pwCollapsed ? 'Expand Player Pool' : 'Collapse Player Pool');
                elements.togglePoolBtn.setAttribute('aria-expanded', (!pwCollapsed).toString());
            }

            function handleCardClick(event) {
                const star = event.target.closest('.star-icon');
                if (star) {
                    const isFav = star.classList.toggle('favorited');
                    star.textContent = isFav ? '★' : '☆';
                    star.setAttribute('aria-pressed', isFav);
                    return;
                }
                
                const card = event.target.closest('.player-card');
                if (card) {
                    card.classList.toggle('stricken');
                }
            }


            function handleSave() {
                if (allPlayersData.length === 0) {
                    showNotification("Please load a player list before saving.", "error");
                    return;
                }

                const state = { tiers: {}, favorites: [], stricken: [] };
                
                elements.tiersContainer.querySelectorAll('.tier-slots').forEach((tier, index) => {
                    state.tiers[`tier${index + 1}`] = Array.from(tier.children).map(card => card.id);
                });
                
                document.querySelectorAll('.star-icon.favorited').forEach(star => 
                    state.favorites.push(star.closest('.player-card').id));
                
                document.querySelectorAll('.player-card.stricken').forEach(card => 
                    state.stricken.push(card.id));
                
                const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `nhl-tiers-save-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(link.href);
                
                showNotification("Progress saved successfully!", "success");
            }

            function handleLoad(event) {
                if (allPlayersData.length === 0) {
                    showNotification("Please load the main Player CSV file first.", "error");
                    event.target.value = '';
                    return;
                }
                
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const state = JSON.parse(e.target.result);
                        restoreState(state);
                        showNotification("Progress loaded successfully!", "success");
                    } catch (error) {
                        showNotification("Error reading save file.", "error");
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            function restoreState(state) {
                const allCards = new Map();
                document.querySelectorAll('.player-card').forEach(card => allCards.set(card.id, card));
                
                elements.playerPool.innerHTML = '';
                elements.tiersContainer.querySelectorAll('.tier-slots').forEach(tier => tier.innerHTML = '');
                
                for (const tierId in state.tiers) {
                    const tierNum = tierId.replace('tier', '');
                    const tierElement = elements.tiersContainer.querySelector(`[data-tier-num='${tierNum}']`);
                    if (tierElement) {
                        state.tiers[tierId].forEach(cardId => {
                            if (allCards.has(cardId)) {
                                tierElement.appendChild(allCards.get(cardId));
                                allCards.delete(cardId);
                            }
                        });
                    }
                }
                
                allCards.forEach(card => elements.playerPool.appendChild(card));
                
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.remove('stricken');
                    const star = card.querySelector('.star-icon');
                    if (star) {
                        star.classList.remove('favorited');
                        star.textContent = '☆';
                    }
                });
                
                state.favorites?.forEach(cardId => {
                    const star = document.querySelector(`#${cardId} .star-icon`);
                    if (star) {
                        star.classList.add('favorited');
                        star.textContent = '★';
                    }
                });
                
                state.stricken?.forEach(cardId => {
                    const card = document.querySelector(`#${cardId}`);
                    if (card) card.classList.add('stricken');
                });
                
                elements.tiersContainer.querySelectorAll('.tier-slots').forEach(updateSlotCount);
                updateAndRenderPlayerPool();
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                showNotification("Processing CSV file...", "info");
                
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        allPlayersData = results.data.filter(player => player && player.PLAYER);
                        buildTiers();
                        elements.playerPool.innerHTML = '';
                        
                        allPlayersData.forEach(player => {
                            elements.playerPool.appendChild(createPlayerCard(player));
                        });
                        
                        initializeSortable();
                        updateAndRenderPlayerPool();
                        showNotification(`Loaded ${allPlayersData.length} players successfully!`, "success");
                    },
                    error: (err) => {
                        showNotification(`Error parsing CSV: ${err}`, "error");
                    }
                });
            }

            function handleCriteriaUpdate() {
                for (const stat in criteria) {
                    for (const level in criteria[stat]) {
                        const inputId = `${stat}-${level}`;
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            criteria[stat][level] = parseInt(inputElement.value, 10) || 0;
                        }
                    }
                }
                
                document.querySelectorAll('.player-card').forEach(card => {
                    const playerId = parseInt(card.id.split('-')[1]);
                    const playerData = allPlayersData.find(p => p.LWLRANK === playerId);
                    if (playerData) {
                        const isFavorited = card.querySelector('.star-icon')?.classList.contains('favorited');
                        const isStricken = card.classList.contains('stricken');
                        
                        // Replace the card's inner content instead of the whole element
                        card.innerHTML = createPlayerCardInnerHtml(playerData);
                        
                        if (isFavorited) {
                            const star = card.querySelector('.star-icon');
                            star.classList.add('favorited');
                            star.textContent = '★';
                        }
                        if (isStricken) card.classList.add('stricken');
                    }
                });
                
                showNotification("Criteria updated successfully!", "success");
            }


            function buildTiers() {
                elements.tiersContainer.innerHTML = '';
                for (let i = 1; i <= 16; i++) {
                    elements.tiersContainer.appendChild(createTierElement(i));
                }
            }

            function updateAndRenderPlayerPool() {
                if (allPlayersData.length === 0) return;
                
                const [sortKey, sortOrder] = elements.sortSelect.value.split('-');
                const activeFilters = new Set();
                
                elements.filterCheckboxes.forEach(cb => {
                    if (cb.checked) activeFilters.add(cb.value);
                });
                
                const cardsInPool = Array.from(elements.playerPool.children);
                
                cardsInPool.forEach(card => {
                    const playerId = parseInt(card.id.split('-')[1]);
                    const playerData = allPlayersData.find(p => p.LWLRANK === playerId);
                    if (!playerData) {
                        card.style.display = 'none';
                        return;
                    }
                    
                    const posGroup = getPositionGroup(playerData.YPOS);
                    card.style.display = activeFilters.has(posGroup) ? '' : 'none';
                });
                
                const visibleCards = cardsInPool.filter(card => card.style.display !== 'none');
                
                visibleCards.sort((a, b) => {
                    const playerA = allPlayersData.find(p => p.LWLRANK === parseInt(a.id.split('-')[1]));
                    const playerB = allPlayersData.find(p => p.LWLRANK === parseInt(b.id.split('-')[1]));
                    if (!playerA || !playerB) return 0;
                    
                    const valA = playerA[sortKey] ?? 0;
                    const valB = playerB[sortKey] ?? 0;
                    
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                });
                
                visibleCards.forEach(card => elements.playerPool.appendChild(card));
            }

            function createPlayerCard(player) {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.id = `player-${player.LWLRANK}`;
                card.dataset.playerName = player.PLAYER;
                const posGroup = getPositionGroup(player.YPOS);
                card.classList.add(`border-${posGroup}`);
                card.innerHTML = createPlayerCardInnerHtml(player);
                return card;
            }
            
            function createPlayerCardInnerHtml(player) {
                const posGroup = getPositionGroup(player.YPOS);
                const logoName = teamNameMap[player.TEAM] || player.TEAM;
                const logoSrc = `NHL Logos/${encodeURIComponent(logoName)}.png`;
                const positionClass = posGroup === 'defenseman' ? 'defense' : posGroup;
                
                let statsHtml = '';
                if (posGroup === 'goalie') {
                    statsHtml = `
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-style: italic;">
                            🥅 Goalie Stats Not Available
                        </div>`;
                } else {
                    statsHtml = `
                        <div class="stats">
                            ${getStatMarkup(player.P_PTS, 'pts', '🎯')}
                            ${getStatMarkup(player.P_SOG, 'sog', '🏒')}
                            ${getStatMarkup(player.P_H, 'hits', '💥')}
                        </div>`;
                }
                
                return `
                    <span class="star-icon">☆</span>
                    <div class="player-info">
                        <img src="${logoSrc}" class="team-logo" alt="${player.TEAM}" onerror="this.style.display='none'">
                        <div class="player-details">
                            <h3 class="player-name">${player.PLAYER}</h3>
                            <div class="player-meta">
                                <span class="position-badge ${positionClass}">${player.YPOS}</span>
                                <span>${player.TEAM}</span>
                            </div>
                        </div>
                    </div>
                    ${statsHtml}
                `;
            }

            function createTierElement(tierNum) {
                const tier = document.createElement('div');
                tier.className = 'tier';
                
                tier.innerHTML = `
                    <h3>
                        <span class="tier-badge">Tier ${tierNum}</span>
                        <span class="slot-count">(0/12)</span>
                    </h3>
                `;
                
                const slots = document.createElement('div');
                slots.className = 'tier-slots';
                slots.dataset.tierNum = tierNum;
                tier.appendChild(slots);
                
                return tier;
            }

            function initializeSortable() {
                const containers = [elements.playerPool, ...document.querySelectorAll('.tier-slots')];
                
                containers.forEach(container => {
                    new Sortable(container, {
                        group: 'players',
                        animation: 200,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onAdd: (evt) => {
                            if (evt.to.classList.contains('tier-slots')) {
                                updateSlotCount(evt.to);
                                if (evt.to.children.length > 12) {
                                    showNotification(`Tier ${evt.to.dataset.tierNum} is full! (Max 12 players)`, "error");
                                    evt.from.appendChild(evt.item);
                                    updateSlotCount(evt.to);
                                    updateSlotCount(evt.from);
                                }
                            }
                        },
                        onRemove: (evt) => {
                            if (evt.from.classList.contains('tier-slots')) {
                                updateSlotCount(evt.from);
                            }
                        }
                    });
                });
            }

            function initializeCriteriaForm() {
                for (const stat in criteria) {
                    for (const level in criteria[stat]) {
                        const inputId = `${stat}-${level}`;
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            inputElement.value = criteria[stat][level];
                        }
                    }
                }
            }

            function getPositionGroup(ypos) {
                if (!ypos) return 'forward';
                if (ypos.includes('G')) return 'goalie';
                if (ypos.includes('D')) return 'defenseman';
                return 'forward';
            }

            function getStatMarkup(value, type, icon) {
                if (!value && value !== 0) return `<div class="stat-pill pill-average">${icon} N/A</div>`;
                
                let className = 'pill-average';
                const statCriteria = criteria[type];
                
                if (value >= statCriteria.elite) {
                    className = 'pill-elite';
                } else if (value >= statCriteria.good) {
                    className = 'pill-good';
                } else if (value < statCriteria.low) {
                    className = 'pill-low';
                }
                
                return `<div class="stat-pill ${className}">${icon} ${value}</div>`;
            }

            function updateSlotCount(tierSlot) {
                if (!tierSlot.dataset.tierNum && tierSlot.id !== 'player-pool') return;
                
                const count = tierSlot.children.length;
                const countElement = tierSlot.parentElement.querySelector('.slot-count');
                if (countElement) {
                    countElement.textContent = `(${count}/12)`;
                    
                    if (count >= 12) {
                        countElement.style.color = 'var(--accent-red)';
                    } else if (count >= 10) {
                        countElement.style.color = 'var(--accent-yellow)';
                    } else {
                        countElement.style.color = 'var(--text-muted)';
                    }
                }
            }

            function handleSearch(event) {
                const filterText = event.target.value.toLowerCase();
                updateAndRenderPlayerPool();
                
                document.querySelectorAll('#player-pool .player-card').forEach(card => {
                    if (card.style.display !== 'none') {
                        const nameMatch = card.dataset.playerName.toLowerCase().includes(filterText);
                        card.style.display = nameMatch ? '' : 'none';
                    }
                });
            }

            function handleExport() {
                if (allPlayersData.length === 0) {
                    showNotification("Please upload a player file first!", "error");
                    return;
                }
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tier,Rank in Tier,Player,Team,Position,Points,Shots,Hits,Favorited,Stricken\n";
                
                elements.tiersContainer.querySelectorAll('.tier-slots').forEach(tier => {
                    const tierNum = tier.dataset.tierNum;
                    tier.querySelectorAll('.player-card').forEach((card, rank) => {
                        const playerId = parseInt(card.id.split('-')[1]);
                        const playerData = allPlayersData.find(p => p.LWLRANK === playerId);
                        const isFavorited = card.querySelector('.star-icon')?.classList.contains('favorited') ? 'Yes' : 'No';
                        const isStricken = card.classList.contains('stricken') ? 'Yes' : 'No';
                        
                        if (playerData) {
                            csvContent += `${tierNum},${rank + 1},"${playerData.PLAYER}",${playerData.TEAM},${playerData.YPOS},${playerData.P_PTS || 0},${playerData.P_SOG || 0},${playerData.P_H || 0},${isFavorited},${isStricken}\n`;
                        }
                    });
                });
                
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `nhl_tiers_export_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification("Tiers exported successfully!", "success");
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: 10px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255,255,255,0.2);
                    transform: translateX(400px);
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    max-width: 300px;
                `;
                
                const colors = {
                    success: 'linear-gradient(135deg, var(--accent-green), #059669)',
                    error: 'linear-gradient(135deg, var(--accent-red), #dc2626)',
                    info: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',
                    warning: 'linear-gradient(135deg, var(--accent-yellow), #d97706)'
                };
                
                notification.style.background = colors[type] || colors.info;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // Initialize with sample data message
            showNotification("Welcome to the NHL Fantasy Tiering Tool! Upload your CSV to get started.", "info");
        });
    </script>
</body>
</html>